<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OfferBeez Dashboard - VentureBeez</title>
  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { background: rgba(255,255,255,.95); padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0,0,0,.1); position: relative; }
    .header h1 { color: #2c3e50; text-align: center; margin-bottom: 10px; font-size: 2rem; }
    .overall-status { position: absolute; top: 20px; right: 20px; padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,.2); }
    .overall-status.positive { background: linear-gradient(45deg,#28a745,#20c997); color: #fff; }
    .overall-status.negative { background: linear-gradient(45deg,#dc3545,#e74c3c); color: #fff; }

    .action-buttons { text-align: center; margin: 20px 0; }
    .btn { display: inline-block; padding: 12px 24px; margin: 0 8px; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; text-decoration: none; color: #fff; cursor: pointer; transition: all .3s ease; box-shadow: 0 4px 15px rgba(0,0,0,.2); }
    .btn-add { background: linear-gradient(45deg,#28a745,#20c997); }
    .btn-add:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(40,167,69,.4); }
    .btn-edit { background: linear-gradient(45deg,#007bff,#0056b3); padding: 6px 12px; font-size: 12px; }
    .btn-delete { background: linear-gradient(45deg,#dc3545,#c82333); padding: 6px 12px; font-size: 12px; }

    .section-card { background: rgba(255,255,255,.95); border-radius: 15px; padding: 24px; margin: 24px 0; box-shadow: 0 8px 32px rgba(0,0,0,.1); }
    .section-title { text-align: center; color: #2c3e50; font-size: 1.5rem; margin-bottom: 18px; font-weight: 700; }
    
    /* Updated charts grid for 2x2 layout */
    .charts-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      grid-template-rows: 1fr 1fr; 
      gap: 20px; 
      max-width: 1200px; 
      margin: 0 auto; 
    }
    
    .chart-card { background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 8px 25px rgba(0,0,0,.08); }
    .chart-header { text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; color: #fff; font-weight: 700; font-size: 14px; }
    .dev-chart .chart-header { background: linear-gradient(45deg,#17a2b8,#138496); }
    .qa-chart .chart-header { background: linear-gradient(45deg,#ffc107,#e0a800); color: #333; }
    .live-items-chart .chart-header { background: linear-gradient(45deg,#28a745,#20c997); }
    .previous-items-chart .chart-header { background: linear-gradient(45deg,#6c757d,#495057); }
    .chart-container { height: 350px; position: relative; }
    .chart-stats { text-align: center; margin-top: 8px; padding-top: 8px; border-top: 2px solid #f1f3f5; color: #6c757d; font-weight: 600; font-size: 12px; }

    .data-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,.1); }
    .data-table th { background: linear-gradient(45deg,#2c3e50,#34495e); color: #fff; font-weight: 600; padding: 10px 8px; text-align: left; font-size: 12px; border-bottom: 2px solid #34495e; white-space: nowrap; }
    .data-table td { padding: 9px 8px; border-bottom: 1px solid #e9ecef; font-size: 12px; vertical-align: middle; }

    .table-badge { padding: 5px 9px; border-radius: 14px; font-size: 11px; font-weight: 700; color: #fff; display: inline-block; min-width: 54px; text-align: center; }
    .badge-s1,.badge-p1,.badge-fail,.badge-yes { background: linear-gradient(45deg,#dc3545,#c82333); }
    .badge-s2,.badge-p2,.badge-open,.badge-pending { background: linear-gradient(45deg,#ffc107,#e0a800); color: #333; }
    .badge-s3,.badge-p3,.badge-pass,.badge-no,.badge-live { background: linear-gradient(45deg,#28a745,#1e7e34); }

    .action-buttons-table { display: flex; gap: 6px; justify-content: center; }
    .btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 14px; color: #fff; text-decoration: none; }

    @media (max-width:768px){
      .container{padding:10px;}
      .header h1{font-size:1.3rem;}
      .chart-container{height:280px;}
      .charts-grid { 
        grid-template-columns: 1fr; 
        grid-template-rows: repeat(4, 1fr);
      }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>üöÄ OfferBeez Dashboard - VentureBeez</h1>
    <div class="overall-status" th:classappend="${overallStatus == 'NEGATIVE'} ? 'negative' : 'positive'">
      <span th:text="${overallStatus == 'NEGATIVE'} ? '‚ùå NEGATIVE STATUS' : '‚úÖ POSITIVE STATUS'"></span>
    </div>
  </div>

  <div class="action-buttons">
    <a href="/add" class="btn btn-add">‚ûï Add New Item</a>
  </div>

  <!-- Charts Section -->
  <div class="section-card">
    <div class="section-title">üìä Dashboard Charts - 2x2 Grid Layout</div>
    <div class="charts-grid">
      <div class="chart-card dev-chart">
        <div class="chart-header">üîß Development: Each Bar = S1(red) + S2(yellow) + S3(green)</div>
        <div class="chart-container"><canvas id="devChart"></canvas></div>
        <div class="chart-stats">Total Dev Items: <span id="devTotal">0</span></div>
      </div>

      <div class="chart-card qa-chart">
        <div class="chart-header">üß™ QA: Each Bar = P1(red) + P2(yellow) + P3(green)</div>
        <div class="chart-container"><canvas id="qaChart"></canvas></div>
        <div class="chart-stats">Total QA Items: <span id="qaTotal">0</span></div>
      </div>

      <div class="chart-card live-items-chart">
        <div class="chart-header">üü¢ Live Items: Current Production Issues</div>
        <div class="chart-container"><canvas id="liveItemsChart"></canvas></div>
        <div class="chart-stats">Total Live Items: <span id="liveItemsTotal">0</span></div>
      </div>

      <div class="chart-card previous-items-chart">
        <div class="chart-header">üîµ Previous Items: Historical Issues</div>
        <div class="chart-container"><canvas id="previousItemsChart"></canvas></div>
        <div class="chart-stats">Total Previous Items: <span id="previousItemsTotal">0</span></div>
      </div>
    </div>
  </div>

  <!-- Table Section -->
  <div class="section-card">
    <div class="section-title">üìã Detailed Dashboard Items</div>
    <table class="data-table">
      <thead>
      <tr>
        <th>ID</th><th>Project</th><th>Bug #</th><th>Issue</th>
        <th>Severity</th><th>Priority</th><th>New User</th><th>Partner</th>
        <th>Admin</th><th>Sales</th><th>Status</th><th>Live</th>
        <th>In Dev</th><th>In QA</th><th>Reopen</th><th>Verify & Closed</th>
        <th>Remarks</th><th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="item : ${devItems}">
        <td th:text="${item.id}"></td>
        <td th:text="${item.project}"></td>
        <td th:text="${item.bugNumber}"></td>
        <td th:text="${item.issue}"></td>
        <td><span th:text="${item.severity}" th:class="'table-badge badge-' + ${item.severity}"></span></td>
        <td><span th:text="${item.priority}" th:class="'table-badge badge-' + ${item.priority}"></span></td>
        <td><span th:text="${item.newUser}" th:class="'table-badge badge-' + ${item.newUser}"></span></td>
        <td><span th:text="${item.partner}" th:class="'table-badge badge-' + ${item.partner}"></span></td>
        <td><span th:text="${item.admin}" th:class="'table-badge badge-' + ${item.admin}"></span></td>
        <td><span th:text="${item.sales}" th:class="'table-badge badge-' + ${item.sales}"></span></td>
        <td><span th:text="${item.status}" th:class="'table-badge badge-' + ${item.status}"></span></td>
        <td><span th:text="${item.live} ? 'Live' : 'Previous'" th:class="'table-badge badge-' + (${item.live} ? 'live' : 'no')"></span></td>
        <td><span th:text="${item.inDev}" th:class="'table-badge badge-' + ${item.inDev}"></span></td>
        <td><span th:text="${item.inQA}" th:class="'table-badge badge-' + ${item.inQA}"></span></td>
        <td th:text="${item.reopen}"></td>
        <td th:text="${item.verifyAndClosed}"></td>
        <td th:text="${item.remarks}"></td>
        <td>
          <div class="action-buttons-table">
            <a th:href="@{/edit/{id}(id=${item.id})}" class="btn btn-edit btn-sm">‚úèÔ∏è Edit</a>
            <a th:href="@{/delete/{id}(id=${item.id})}" class="btn btn-delete btn-sm" onclick="return confirm('Delete this item?')">üóëÔ∏è Delete</a>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() { 
    console.log('DOM loaded, initializing charts...');
    initializeCharts(); 
});

function initializeCharts() {
  const rows = document.querySelectorAll('.data-table tbody tr');
  console.log(`Found ${rows.length} rows in table`);

  // Initialize data structures for each category
  const categories = ['Partner', 'Sales', 'New User', 'Admin'];
  
  // Dev and QA data by category and severity/priority
  let devSeverityData = {};
  let devPriorityData = {};
  let qaSeverityData = {};
  let qaPriorityData = {};
  
  // Live and Previous data structures
  let liveItemsData = {};
  let previousItemsData = {};
  
  categories.forEach(cat => {
    devSeverityData[cat] = { s1: 0, s2: 0, s3: 0 };
    devPriorityData[cat] = { p1: 0, p2: 0, p3: 0 };
    qaSeverityData[cat] = { s1: 0, s2: 0, s3: 0 };
    qaPriorityData[cat] = { p1: 0, p2: 0, p3: 0 };
    
    // Initialize live and previous data
    liveItemsData[cat] = { s1: 0, s2: 0, s3: 0 };
    previousItemsData[cat] = { s1: 0, s2: 0, s3: 0 };
  });

  rows.forEach((row, index) => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 18) {
      console.log(`Row ${index} has insufficient cells: ${cells.length}`);
      return;
    }

    // Get values from table cells (trimmed and lowercased for comparison)
    const severity = cells[4].textContent.trim().toLowerCase();
    const priority = cells[5].textContent.trim().toLowerCase();
    const newUser = cells[6].textContent.trim().toLowerCase();
    const partner = cells[7].textContent.trim().toLowerCase();
    const admin = cells[8].textContent.trim().toLowerCase();
    const sales = cells[9].textContent.trim().toLowerCase();
    const inDev = cells[12].textContent.trim().toLowerCase();
    const inQA = cells[13].textContent.trim().toLowerCase();
    
    // Get live status from the "Live" column (index 11)
    const liveStatus = cells[11].textContent.trim().toLowerCase();
    const isLive = liveStatus === 'live';

    console.log(`Row ${index}:`, {
      severity, priority, newUser, partner, admin, sales, inDev, inQA, liveStatus, isLive
    });

    // Determine which categories this item belongs to
    const itemCategories = [];
    if (newUser === 'yes') itemCategories.push('New User');
    if (partner === 'yes') itemCategories.push('Partner');
    if (admin === 'yes') itemCategories.push('Admin');
    if (sales === 'yes') itemCategories.push('Sales');

    console.log(`Row ${index} categories:`, itemCategories);

    // If no category is marked, skip this item
    if (itemCategories.length === 0) {
      console.log(`Row ${index} has no categories marked, skipping`);
      return;
    }

    // Count for each applicable category
    itemCategories.forEach(category => {
      // Count Dev items (items that are in development)
      if (inDev === 'open' || inDev === 'pass' || inDev === 'fail' || inDev === 'pending') {
        // Count by severity
        if (severity === 's1') {
          devSeverityData[category].s1++;
          console.log(`Added S1 dev item for ${category}`);
        } else if (severity === 's2') {
          devSeverityData[category].s2++;
          console.log(`Added S2 dev item for ${category}`);
        } else if (severity === 's3') {
          devSeverityData[category].s3++;
          console.log(`Added S3 dev item for ${category}`);
        }
        
        // Count by priority
        if (priority === 'p1') {
          devPriorityData[category].p1++;
        } else if (priority === 'p2') {
          devPriorityData[category].p2++;
        } else if (priority === 'p3') {
          devPriorityData[category].p3++;
        }
      }

      // Count QA items (items that are in QA)
      if (inQA === 'open' || inQA === 'pass' || inQA === 'fail' || inQA === 'pending') {
        // Count by severity
        if (severity === 's1') {
          qaSeverityData[category].s1++;
          console.log(`Added S1 QA item for ${category}`);
        } else if (severity === 's2') {
          qaSeverityData[category].s2++;
          console.log(`Added S2 QA item for ${category}`);
        } else if (severity === 's3') {
          qaSeverityData[category].s3++;
          console.log(`Added S3 QA item for ${category}`);
        }
        
        // Count by priority
        if (priority === 'p1') {
          qaPriorityData[category].p1++;
        } else if (priority === 'p2') {
          qaPriorityData[category].p2++;
        } else if (priority === 'p3') {
          qaPriorityData[category].p3++;
        }
      }

      // Count Live and Previous items by severity
      if (isLive) {
        if (severity === 's1') {
          liveItemsData[category].s1++;
        } else if (severity === 's2') {
          liveItemsData[category].s2++;
        } else if (severity === 's3') {
          liveItemsData[category].s3++;
        }
      } else {
        if (severity === 's1') {
          previousItemsData[category].s1++;
        } else if (severity === 's2') {
          previousItemsData[category].s2++;
        } else if (severity === 's3') {
          previousItemsData[category].s3++;
        }
      }
    });
  });

  // Log final data for debugging
  console.log('Dev Severity Data:', devSeverityData);
  console.log('Dev Priority Data:', devPriorityData);
  console.log('QA Severity Data:', qaSeverityData);
  console.log('QA Priority Data:', qaPriorityData);
  console.log('Live Items Data:', liveItemsData);
  console.log('Previous Items Data:', previousItemsData);

  // Calculate totals
  let devTotal = 0, qaTotal = 0, liveTotal = 0, previousTotal = 0;
  categories.forEach(cat => {
    const devCatTotal = devSeverityData[cat].s1 + devSeverityData[cat].s2 + devSeverityData[cat].s3;
    const qaCatTotal = qaSeverityData[cat].s1 + qaSeverityData[cat].s2 + qaSeverityData[cat].s3;
    const liveCatTotal = liveItemsData[cat].s1 + liveItemsData[cat].s2 + liveItemsData[cat].s3;
    const previousCatTotal = previousItemsData[cat].s1 + previousItemsData[cat].s2 + previousItemsData[cat].s3;
    
    devTotal += devCatTotal;
    qaTotal += qaCatTotal;
    liveTotal += liveCatTotal;
    previousTotal += previousCatTotal;
    
    console.log(`${cat}: Dev=${devCatTotal}, QA=${qaCatTotal}, Live=${liveCatTotal}, Previous=${previousCatTotal}`);
  });

  console.log(`Totals: Dev=${devTotal}, QA=${qaTotal}, Live=${liveTotal}, Previous=${previousTotal}`);

  // Update totals in UI
  setText('devTotal', devTotal);
  setText('qaTotal', qaTotal);
  setText('liveItemsTotal', liveTotal);
  setText('previousItemsTotal', previousTotal);

  // Create 4 charts in 2x2 grid
  createStackedSeverityChart('devChart', 'Development Items by Severity', devSeverityData);
  createStackedPriorityChart('qaChart', 'QA Items by Priority', qaPriorityData);
  createStackedSeverityChart('liveItemsChart', 'Live Items by Severity', liveItemsData);
  createStackedSeverityChart('previousItemsChart', 'Previous Items by Severity', previousItemsData);
}

function setText(id, value) {
  const element = document.getElementById(id);
  if (element) {
    element.textContent = value;
    console.log(`Set ${id} to ${value}`);
  } else {
    console.log(`Element ${id} not found`);
  }
}

function createStackedSeverityChart(canvasId, title, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) {
    console.log(`Canvas ${canvasId} not found`);
    return;
  }
  const ctx = canvas.getContext('2d');

  const categories = ['Partner', 'Sales', 'New User', 'Admin'];
  
  const datasets = [
    {
      label: 'S1 (Critical)',
      data: categories.map(cat => data[cat].s1),
      backgroundColor: '#dc3545',
      borderColor: '#dc3545',
      borderWidth: 1
    },
    {
      label: 'S2 (High)',
      data: categories.map(cat => data[cat].s2),
      backgroundColor: '#ffc107',
      borderColor: '#ffc107',
      borderWidth: 1
    },
    {
      label: 'S3 (Medium)',
      data: categories.map(cat => data[cat].s3),
      backgroundColor: '#28a745',
      borderColor: '#28a745',
      borderWidth: 1
    }
  ];

  console.log(`Creating ${canvasId} with data:`, datasets);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: categories,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: true,
          grid: { display: false }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: { 
            stepSize: 1, 
            callback: (v) => Number.isInteger(v) ? v : ''
          },
          grid: { color: '#e9ecef' }
        }
      },
      plugins: {
        legend: { 
          display: true,
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            title: (tooltipItems) => {
              return `${tooltipItems[0].label} Category`;
            },
            label: (context) => {
              return `${context.dataset.label}: ${context.parsed.y} items`;
            },
            footer: (tooltipItems) => {
              const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
              return `Total for ${tooltipItems[0].label}: ${total} items`;
            }
          }
        }
      },
      animation: { 
        duration: 900, 
        easing: 'easeInOutQuart' 
      }
    }
  });
}

function createStackedPriorityChart(canvasId, title, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) {
    console.log(`Canvas ${canvasId} not found`);
    return;
  }
  const ctx = canvas.getContext('2d');

  const categories = ['Partner', 'Sales', 'New User', 'Admin'];
  
  const datasets = [
    {
      label: 'P1 (Urgent)',
      data: categories.map(cat => data[cat].p1),
      backgroundColor: '#dc3545',
      borderColor: '#dc3545',
      borderWidth: 1
    },
    {
      label: 'P2 (High)',
      data: categories.map(cat => data[cat].p2),
      backgroundColor: '#ffc107',
      borderColor: '#ffc107',
      borderWidth: 1
    },
    {
      label: 'P3 (Normal)',
      data: categories.map(cat => data[cat].p3),
      backgroundColor: '#28a745',
      borderColor: '#28a745',
      borderWidth: 1
    }
  ];

  console.log(`Creating ${canvasId} with data:`, datasets);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: categories,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: true,
          grid: { display: false }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: { 
            stepSize: 1, 
            callback: (v) => Number.isInteger(v) ? v : ''
          },
          grid: { color: '#e9ecef' }
        }
      },
      plugins: {
        legend: { 
          display: true,
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            title: (tooltipItems) => {
              return `${tooltipItems[0].label} Category`;
            },
            label: (context) => {
              return `${context.dataset.label}: ${context.parsed.y} items`;
            },
            footer: (tooltipItems) => {
              const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
              return `Total for ${tooltipItems[0].label}: ${total} items`;
            }
          }
        }
      },
      animation: { 
        duration: 900, 
        easing: 'easeInOutQuart' 
      }
    }
  });
}
</script>
</body>
</html>
